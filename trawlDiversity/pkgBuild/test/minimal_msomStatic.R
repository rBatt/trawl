# ============
# = Data Set =
# ============
staticData <- structure(list(X = structure(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 
1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 
0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 
1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 
0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), .Dim = c(3L, 3L, 7L, 15L)), 
    U = structure(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1.5, 1.9, 3.55714285714286, 
    3.04666666666667, 3.1375, 3.43076923076923, 0.757142857142857, 
    2.23333333333333, 1.83333333333333, 2.25, 3.61, 12.6532653061224, 
    9.28217777777778, 9.84390625, 11.7701775147929, 0.573265306122449, 
    4.98777777777778, 3.36111111111111), .Dim = c(3L, 3L, 3L), .Dimnames = list(
        c("2000", "2001", "2002"), c("-165.5 57.5", "-172.5 57.5", 
        "-175.5 60.5"), c("Intercept", "bt", "bt2"))), V = structure(c(1, 
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
    1, 1, 1, 1, 1, -0.969346902235006, -1.30111741936901, -0.902992798808205, 
    1.15398440742263, 0.556797476581418, 0.424089269727816, 0.755859786861821, 
    1.02127620056903, 1.28669261427623, -0.969346902235006, -1.30111741936901, 
    -0.902992798808205, 1.15398440742263, 0.556797476581418, 
    0.424089269727816, 0.755859786861821, 1.08763030399583, 1.28669261427623, 
    -0.969346902235006, -1.10205510908861, -1.10205510908861, 
    1.15398440742263, 0.556797476581418, 0.357735166301015, 0.68950568343502, 
    1.08763030399583, 1.22033851084943, -0.969346902235006, -1.10205510908861, 
    -1.10205510908861, 1.35304671770303, 0.490443373154617, 0.357735166301015, 
    0, 1.08763030399583, 0, -0.969346902235006, -1.10205510908861, 
    -0.969346902235006, 1.28669261427623, 0.556797476581418, 
    0.357735166301015, 0, 0, 0, 0, 0, -0.969346902235006, 1.28669261427623, 
    0, 0, 0, 0, 0, 0, 0, -0.969346902235006, 0, 0, 0, 0, 0, 0, 
    0.939633416872603, 1.69290653898548, 0.815395994699476, 1.33168001257455, 
    0.310023429927435, 0.179851708698272, 0.571324017394798, 
    1.0430050778487, 1.655577883633, 0.939633416872603, 1.69290653898548, 
    0.815395994699476, 1.33168001257455, 0.310023429927435, 0.179851708698272, 
    0.571324017394798, 1.18293967817005, 1.655577883633, 0.939633416872603, 
    1.2145254634683, 1.2145254634683, 1.33168001257455, 0.310023429927435, 
    0.127974449208415, 0.475418087489194, 1.18293967817005, 1.4892260810622, 
    0.939633416872603, 1.2145254634683, 1.2145254634683, 1.83073542028695, 
    0.240534702271279, 0.127974449208415, 0, 1.18293967817005, 
    0, 0.939633416872603, 1.2145254634683, 0.939633416872603, 
    1.655577883633, 0.310023429927435, 0.127974449208415, 0, 
    0, 0, 0, 0, 0.939633416872603, 1.655577883633, 0, 0, 0, 0, 
    0, 0, 0, 0.939633416872603, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 
    1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 
    0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 
    1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 
    0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 
    0, 1, 0, 0, 0, 0, 0, 0), .Dim = c(3L, 3L, 7L, 5L), .Dimnames = list(
        c("2000", "2001", "2002"), c("-165.5 57.5", "-172.5 57.5", 
        "-175.5 60.5"), c("1", "2", "3", "4", "5", "6", "7"), 
        c("Intercept", "doy", "doy2", "yr2001", "yr2002"))), 
    nU = 3L, nV = 5L, nK = structure(c(5, 5, 7, 6, 5, 5, 3, 4, 
    3), .Dim = c(3L, 3L), .Dimnames = structure(list(year = c("2000", 
    "2001", "2002"), stratum = c("-165.5 57.5", "-172.5 57.5", 
    "-175.5 60.5")), .Names = c("year", "stratum"))), nT = 3L, 
    Jmax = 3L, Kmax = 7L, N = 5L, nS = 15, isUnobs = structure(c(0L, 
    0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 
    0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 
    0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 0L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
    1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L), .Dim = c(3L, 
    3L, 15L)), nJ = structure(c(3L, 3L, 3L), .Names = c("2000", 
    "2001", "2002"))), .Names = c("X", "U", "V", "nU", "nV", 
"nK", "nT", "Jmax", "Kmax", "N", "nS", "isUnobs", "nJ"))


# ==============
# = Stan Model =
# ==============
model_file="
// =============
// = Functions =
// =============
functions {
	
	// ---- log probability functions ----
	
	// lp for species that are observed
	real lp_obs(int x, real logit_psi, real logit_theta) {
		return log_inv_logit(logit_psi) + bernoulli_logit_log(x, logit_theta);
	}
	
	vector lp_obs2(int[] x, vector lil_lp, row_vector logit_theta) {
		return lil_lp + bernoulli_logit_log(x, logit_theta);
	}
	
	// lp for species that aren't observed, but known to exist
	real lp_unobs(real logit_psi, real logit_theta) {
		return log_sum_exp(lp_obs(0, logit_psi, logit_theta), log1m_inv_logit(logit_psi));
	}
	
	// lp that works as either lp_obs or lp_unobs, depending on isUnobs values
	real lp_exists(int[] x, row_vector logit_psi, row_vector logit_theta, vector isUnobs, vector lil_lp) {
		// FYI: both isUnobs and x are from X[t,j], 
		// isUnobs is !max() swept out across X[t,j,1:K,n] for 1:N, x is just X[t,j,k,1:N]
		// Intention is that isUnobs will be 0 for each x that is observed for any k.
		return log_sum_exp(log_sum_exp(lp_obs2(x, lil_lp, logit_theta)), log_sum_exp(lil_lp .* isUnobs));
	}
	
	// lp for species that were never observed
	real lp_never_obs(real logit_psi, real logit_theta, real Omega) {
		real lp_unavailable;
		real lp_available;
		lp_unavailable <- bernoulli_log(0, Omega);
		lp_available <- bernoulli_log(1, Omega) + lp_unobs(logit_psi, logit_theta);
		return log_sum_exp(lp_unavailable, lp_available);
	}
	
}


// ========
// = Data =
// ========
data {
    int<lower=1> nT; // number of years
    int<lower=1> Kmax; // max samples in a site-year
    int<lower=1> Jmax; // number of sites
		int<lower=0, upper=Jmax> nJ[nT]; // number of sites in each year
    int<lower=0, upper=Kmax> nK[nT,Jmax]; // number of samples (replicates/ hauls)
    int nU; // number of Covariates for psi (presence)
    int nV; // number of Covariates for theta (detection)
    
		int N; // total number of observed species (anywhere, ever)
		int<lower=1> nS; // size of super population, includes unknown species
		vector[nS] isUnobs[nT,Jmax]; // was a species unobserved (across all K) each site-year?
    
    matrix[Jmax,nU] U[nT]; // covariates for psi (presence)
    matrix[Kmax,nV] V[nT,Jmax]; // covariates for theta (detectability)
    
    int X[nT,Jmax,Kmax,nS]; // species observations
}


// ====================
// = Transformed Data =
// ====================
// transformed data {
// 
// }


// ==============
// = Parameters =
// ==============
parameters {	
	real<lower=0, upper=1> Omega[nT]; // average availability
	
	vector[nU] alpha_mu; // hyperparameter mean
	vector<lower=0>[nU] alpha_sd; // hyperparameter sd
	matrix[nU,nS] alpha; // presence coefficient
	
	vector[nV] beta_mu; // hyperparameter mean
	vector<lower=0>[nV] beta_sd; // hyperparameter sd
	matrix[nV,nS] beta; // detection coefficient
}


// ==========================
// = Transformed Parameters =
// ==========================
// transformed parameters {
// 
// }


// =========
// = Model =
// =========
model {
	// Priors for hyperparameters
	alpha_mu ~ cauchy(0, 1);
	alpha_sd ~ cauchy(0, 2);
	beta_mu ~ cauchy(0, 1);
	beta_sd ~ cauchy(0, 2);
	
	Omega ~ beta(2,2);
	
	// Priors for parameters
	for (u in 1:nU) {
		alpha[u] ~ normal(alpha_mu[u], alpha_sd[u]);
	}
	for (v in 1:nV) {
		beta[v] ~ normal(beta_mu[v], beta_sd[v]);
	}
	
	
	// ---- Begin Looping down to Point Observations ----
	for (t in 1:nT) { // loop through years
		increment_log_prob(bernoulli_log(1, Omega[t]) * N * sum(nK[t])); // observed, so available
		
		if(nJ[t]){
			matrix[nJ[t],nS] logit_psi; // presence probability
			logit_psi <- block(U[t], 1, 1, nJ[t], nU)*alpha; // block matrix algebra for speed
		
			for (j in 1:Jmax) { // sites
			
				if(nK[t,j]){ // if samples in site
					
					row_vector[N] t_logit_psi;
					vector[N] lil_lp;
					matrix[nK[t,j],nS] logit_theta; // detection probability
					
					t_logit_psi <- sub_row(logit_psi, j, 1, N);
					for (nn in 1:N)
						lil_lp[nn] <- log1m_inv_logit(t_logit_psi[nn]);
					logit_theta <- block(V[t,j], 1, 1, nK[t,j], nV)*beta;
					
					for (k in 1:nK[t,j]) {// sampling events
						
						// lp for species that have been observed at some point
						increment_log_prob(lp_exists(
							segment(X[t,j,k], 1, N), 
							t_logit_psi,
							sub_row(logit_theta, k, 1, N),
							segment(isUnobs[t,j], 1, N),
							lil_lp
						));
				
						for (s in (N+1):nS) { // padded species
							// increment_log_prob(lp_never_obs(logit_psi[t,j,k,s], logit_theta[t,j,k,s], Omega[t]));
							increment_log_prob(lp_never_obs(logit_psi[j,s], logit_theta[k,s], Omega[t]));
						} // end second species loop
					} // end sample loop
				} // if nK
			} // end site loop
		} // if nJ
	} // end year loop
	
} // end model


// ========================
// = Generated Quantities =
// ========================
// generated quantities {
//
// }
"


# =============
# = Fit Model =
# =============
ebs_msom <- stan(
	model_code=model_file, 
	data=staticData, 
	control=list(stepsize=0.05, adapt_delta=0.95),
	chains=4, iter=50, refresh=1, seed=1337, cores=4, verbose=FALSE
)


# =========================
# = Timing and Efficiency =
# =========================
(timing <- cbind(get_elapsed_time(ebs_msom), rowSums(get_elapsed_time(ebs_msom))))
(max_time <- max(timing))
(neff_mu <- mean(summary(ebs_msom)$summary[,"n_eff"]))
(neff_sd <- sd(summary(ebs_msom)$summary[,"n_eff"]))
max_time/neff_mu
